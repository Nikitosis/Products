//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop
#ifndef _MYINCL1_H
#define _MYINCL1_H

#include "ProdForm.h"
#include "Products.h"
#include "MealsForm.h"
#include "Meals.h"
#include <math.h>
#include "Math.hpp"
#include "Main.h"
#include <vector>
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TForm5 *Form5;
//---------------------------------------------------------------------------
__fastcall TForm5::TForm5(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TForm5::Button1Click(TObject *Sender)
{
if (OpenPictureDialog1->Execute())
	{
		 Image1->Picture->LoadFromFile(OpenPictureDialog1->FileName);
	}
}
//---------------------------------------------------------------------------
void __fastcall TForm5::Button2Click(TObject *Sender)
{
int n;

/////////////////////////Проверка на символы(посмотреть!!)
if(Edit2->Text=="")     //если пустое место в едите
Edit2->Text='0';
if(Edit3->Text=="")
Edit2->Text='0';
if(Edit4->Text=="")
Edit4->Text='0';
while(Edit2->Text[1]=='0')           //удаляем первые нули в массах
{
	if(Edit2->Text.Length()>1)
	{
		if(Edit2->Text[2]!=',')
			Edit2->Text=Edit2->Text.Delete(1,1);
		   else
		   break;
	}
	else break;
}
if(Edit2->Text[Edit2->Text.Length()]==',')                 //удаляем последнюю кому
	Edit2->Text=Edit2->Text.Delete(Edit2->Text.Length(),1);

while(Edit3->Text[1]=='0')
{
	if(Edit3->Text.Length()>1)
	{
		if(Edit3->Text[2]!=',')
			Edit3->Text=Edit3->Text.Delete(1,1);
		   else
		   break;
	}
	else break;
}
if(Edit3->Text[Edit3->Text.Length()]==',')
	Edit3->Text=Edit3->Text.Delete(Edit3->Text.Length(),1);

while(Edit4->Text[1]=='0')
{
	if(Edit4->Text.Length()>1)
	{
		if(Edit4->Text[2]!=',')
			Edit4->Text=Edit4->Text.Delete(1,1);
		   else
		   break;
	}
	else break;
}
if(Edit4->Text[Edit4->Text.Length()]==',')
	Edit4->Text=Edit4->Text.Delete(Edit4->Text.Length(),1);
/////////////////////////////////////////


double sum;
sum=100;
if(StrToFloat(Edit2->Text)+StrToFloat(Edit3->Text)+StrToFloat(Edit4->Text)>100)   //если сумма бжу > массы продукта
{
	ShowMessage("Максимальная сумма белков,жиров и углеводов-100г");
	return;
}
if(IsNew)     //если мы зашли через кнопку добавить
{

	n=Form2->Product.size();
	int k;
	k=Form2->ScrollBox1->VertScrollBar->Position;  //нужно обязательно,иначе появл. пропуски
	Form2->ScrollBox1->VertScrollBar->Position=0;

	TForm2::Prod TemporProd;   //временная переменная
	Form2->Product.push_back(TemporProd);

	Form2->Product[n].Panel=new TPanel(Form2);
	Form2->Product[n].Panel->Parent=Form2->ScrollBox1;
	Form2->Product[n].Panel->Top=(n)*Form2->PanelH;
	Form2->Product[n].Panel->Left=0;
	Form2->Product[n].Panel->Width=Form2->ScrollBox1->Width-4;
	Form2->Product[n].Panel->Height=Form2->PanelH;
	Form2->Product[n].Panel->OnMouseEnter=Form2->OnMouseEnter;
	Form2->Product[n].Panel->Visible=true;

	Form2->ScrollBox1->VertScrollBar->Position=k;


	Form2->Product[n].Image=new TImage(Form2);
	Form2->Product[n].Image->Parent=Form2->Product[n].Panel;
	Form2->Product[n].Image->Left=300;
	Form2->Product[n].Image->Height=Form2->PanelH-1;
	Form2->Product[n].Image->Width=125;
	Form2->Product[n].Image->Picture=Image1->Picture;
	Form2->Product[n].Image->Stretch=true;

	Form2->Product[n].Name=new TLabel(Form2);
	Form2->Product[n].Name->Parent=Form2->Product[n].Panel;
	Form2->Product[n].Name->Top=20;
	Form2->Product[n].Name->Left=10;
	Form2->Product[n].Name->WordWrap=true;
	Form2->Product[n].Name->AutoSize=false;
	Form2->Product[n].Name->Height=80;
	Form2->Product[n].Name->Width=270;
	Form2->Product[n].Name->Font->Size=14;
	Form2->Product[n].Name->Caption=Edit1->Text;

	Form2->Product[n].Protein=new TLabel(Form2);
	Form2->Product[n].Protein->Parent=Form2->Product[n].Panel;
	Form2->Product[n].Protein->Top=20;
	Form2->Product[n].Protein->Left=440;
	Form2->Product[n].Protein->WordWrap=true;
	Form2->Product[n].Protein->AutoSize=false;
	Form2->Product[n].Protein->Height=40;
	Form2->Product[n].Protein->Width=50;
	Form2->Product[n].Protein->Font->Size=10;
	Form2->Product[n].Protein->Caption=FloatToStr(SimpleRoundTo(StrToFloat(Edit2->Text)/sum*1000,0));

	Form2->Product[n].Fat=new TLabel(Form2);
	Form2->Product[n].Fat->Parent=Form2->Product[n].Panel;
	Form2->Product[n].Fat->Top=20;
	Form2->Product[n].Fat->Left=533;
	Form2->Product[n].Fat->WordWrap=true;
	Form2->Product[n].Fat->AutoSize=false;
	Form2->Product[n].Fat->Height=20;
	Form2->Product[n].Fat->Width=50;
	Form2->Product[n].Fat->Font->Size=10;
	Form2->Product[n].Fat->Caption=FloatToStr(SimpleRoundTo(StrToFloat(Edit3->Text)/sum*1000,0));

	Form2->Product[n].Carbon=new TLabel(Form2);
	Form2->Product[n].Carbon->Parent=Form2->Product[n].Panel;
	Form2->Product[n].Carbon->Top=20;
	Form2->Product[n].Carbon->Left=625;
	Form2->Product[n].Carbon->WordWrap=true;
	Form2->Product[n].Carbon->AutoSize=false;
	Form2->Product[n].Carbon->Height=20;
	Form2->Product[n].Carbon->Width=50;
	Form2->Product[n].Carbon->Font->Size=10;
	Form2->Product[n].Carbon->Caption=FloatToStr(SimpleRoundTo(StrToFloat(Edit4->Text)/sum*1000,0));

	Form2->Product[n].Calories=new TLabel(Form2);
	Form2->Product[n].Calories->Parent=Form2->Product[n].Panel;
	Form2->Product[n].Calories->Top=20;
	Form2->Product[n].Calories->Left=719;
	Form2->Product[n].Calories->WordWrap=true;
	Form2->Product[n].Calories->AutoSize=false;
	Form2->Product[n].Calories->Height=20;
	Form2->Product[n].Calories->Width=50;
	Form2->Product[n].Calories->Font->Size=10;
	double n1=StrToInt(Form2->Product[n].Protein->Caption)*0.004;
	double n2=StrToInt(Form2->Product[n].Fat->Caption)*0.009;
	double n3=StrToInt(Form2->Product[n].Carbon->Caption)*0.004;
	Form2->Product[n].Calories->Caption=FloatToStr(SimpleRoundTo(n1+n2+n3,-2));
   //	Form2->Labeles[n*5+4]->Caption=Edit;

	Form2->Product[n].SettingButton=new TBitBtn(Form2);
	Form2->Product[n].SettingButton->Parent=Form2->Product[n].Panel;
	Form2->Product[n].SettingButton->Left=820;
	Form2->Product[n].SettingButton->Height=Form2->PanelH-1;
	Form2->Product[n].SettingButton->Width=100;
	Form2->Product[n].SettingButton->Tag=n;
	Form2->Product[n].SettingButton->OnClick=Form2->PropClick;
	Form2->Product[n].SettingButton->Glyph=BitBtn1->Glyph;
	Form2->Product[n].SettingButton->OnMouseEnter=SettingsEnter;


	TImage *line=new TImage(Form2);               //рисуем линии
	line->Parent=Form2->Product[n].Panel;
	line->Left=300;
	line->Width=2;
	line->Height=Form2->PanelH-1;
	line->Picture->Bitmap->Width=2;
	line->Picture->Bitmap->Height=Form2->PanelH-1;
	line->Picture->Bitmap->Canvas->Brush->Color=clBlack;
	line->Picture->Bitmap->Canvas->FillRect(Rect(0,0,2,100));

	TImage *line2=new TImage(Form2);
	line2->Parent=Form2->Product[n].Panel;
	line2->Left=427;
	line2->Width=2;
	line2->Height=Form2->PanelH-1;
	line2->Picture->Bitmap->Width=2;
	line2->Picture->Bitmap->Height=Form2->PanelH-1;
	line2->Picture->Bitmap->Canvas->Brush->Color=clBlack;
	line2->Picture->Bitmap->Canvas->FillRect(Rect(0,0,2,100));

	TImage *line3=new TImage(Form2);
	line3->Parent=Form2->Product[n].Panel;
	line3->Left=520;
	line3->Width=2;
	line3->Height=Form2->PanelH-1;
	line3->Picture->Bitmap->Width=2;
	line3->Picture->Bitmap->Height=Form2->PanelH-1;
	line3->Picture->Bitmap->Canvas->Brush->Color=clBlack;
	line3->Picture->Bitmap->Canvas->FillRect(Rect(0,0,2,100));

	TImage *line4=new TImage(Form2);
	line4->Parent=Form2->Product[n].Panel;
	line4->Left=613;
	line4->Width=2;
	line4->Height=Form2->PanelH-1;
	line4->Picture->Bitmap->Width=2;
	line4->Picture->Bitmap->Height=Form2->PanelH-1;
	line4->Picture->Bitmap->Canvas->Brush->Color=clBlack;
	line4->Picture->Bitmap->Canvas->FillRect(Rect(0,0,2,100));

	TImage *line5=new TImage(Form2);
	line5->Parent=Form2->Product[n].Panel;
	line5->Left=706;
	line5->Width=2;
	line5->Height=Form2->PanelH-1;
	line5->Picture->Bitmap->Width=2;
	line5->Picture->Bitmap->Height=Form2->PanelH-1;
	line5->Picture->Bitmap->Canvas->Brush->Color=clBlack;
	line5->Picture->Bitmap->Canvas->FillRect(Rect(0,0,2,100));

	TImage *line6=new TImage(Form2);
	line6->Parent=Form2->Product[n].Panel;
	line6->Left=819;
	line6->Width=2;
	line6->Height=Form2->PanelH-1;
	line6->Picture->Bitmap->Width=2;
	line6->Picture->Bitmap->Height=Form2->PanelH-1;
	line6->Picture->Bitmap->Canvas->Brush->Color=clBlack;
	line6->Picture->Bitmap->Canvas->FillRect(Rect(0,0,2,100));
	Masses[n*3]=Edit2->Text;        //массы белков углеводов запоминаем
	Masses[n*3+1]=Edit3->Text;
	Masses[n*3+2]=Edit4->Text;

	for(int i=0;i<Form3->Meal.size();i++)   //добавляем веса во все блюда(чтоб не было ошибки при загрузке сохр)
		Form3->Meal[i].Weight[n]='0';
}
	else
	{

		n=Form2->PropNum;
		Form2->Product[n].Image->Picture=Image1->Picture;
		Form2->Product[n].Name->Caption=Edit1->Text;

		Masses[n*3]=Edit2->Text;        //массы белков углеводов запоминаем
		Masses[n*3+1]=Edit3->Text;
		Masses[n*3+2]=Edit4->Text;

		Form2->Product[n].Protein->Caption=FloatToStr(SimpleRoundTo(StrToFloat(Edit2->Text)/sum*1000,0));
		Form2->Product[n].Fat->Caption=FloatToStr(SimpleRoundTo(StrToFloat(Edit3->Text)/sum*1000,0));
		Form2->Product[n].Carbon->Caption=FloatToStr(SimpleRoundTo(StrToFloat(Edit4->Text)/sum*1000,0));

		double n1=StrToInt(Form2->Product[n].Protein->Caption)*0.004;
		double n2=StrToInt(Form2->Product[n].Fat->Caption)*0.009;
		double n3=StrToInt(Form2->Product[n].Carbon->Caption)*0.004;
		Form2->Product[n].Calories->Caption=FloatToStr(SimpleRoundTo(n1+n2+n3,-2));
	}

	for(int i=0;i<Form3->Meal.size();i++)  //пересчитыв калории
		Form3->RecountCal(i);

Close();
}
void __fastcall TForm5::Button3Click(TObject *Sender)
{
Close();
}
//---------------------------------------------------------------------------
#endif


//---------------------------------------------------------------------------



void __fastcall TForm5::Button4Click(TObject *Sender)//удаление продукта
{
int num=Form2->PropNum;
int n=Form2->Product.size();
for(int i=num+1;i<n;i++)
	{
		Form2->Product[i].Panel->Top-=Form2->PanelH;
		Form2->Product[i].SettingButton->Tag--;
	}

for(int i=0;i<Form3->Meal.size();i++)
{
	for(int j=num;j<n-1;j++)
		{
			Form3->Meal[i].IsLeft[j]=Form3->Meal[i].IsLeft[j+1];
			Form3->Meal[i].IsRight[j]=Form3->Meal[i].IsRight[j+1];
			Form3->Meal[i].Weight[j]=Form3->Meal[i].Weight[j+1];
		}
	Form3->Meal[i].IsLeft[n-1]=false;
	Form3->Meal[i].IsRight[n-1]=false;
	Form3->Meal[i].Weight[n-1]="0";
}


Form2->Product[num].Panel->Free();
Form2->Product.erase(Form2->Product.begin()+num);

	for(int i=0;i<Form3->Meal.size();i++)
		Form3->RecountCal();//пересчет калорий

Form3->WasDeleted=-1;
Form3->Close();
Close();
}
//---------------------------------------------------------------------------


void __fastcall TForm5::Edit2Change(TObject *Sender)
{
TEdit *Edit = dynamic_cast<TEdit *>(Sender);
bool flag=false;
for(int i=1;i<=Edit->Text.Length();i++)
{
	if(Edit->Text[i]==',' && flag)        //проверяем на наличие второй точки
	{
		Edit->Text=Edit->Text.Delete(i,1);
		continue;
	}
	if(Edit->Text[i]==',')
	{
		flag=true;
	}

	if(!((Edit->Text[i]>='0' && Edit->Text[i]<='9') || Edit->Text[i]==','))
	Edit->Text=Edit->Text.Delete(i,1);
}
}
//---------------------------------------------------------------------------

void __fastcall TForm5::FormClose(TObject *Sender, TCloseAction &Action)
{
Form2->Show();
}
//---------------------------------------------------------------------------
void __fastcall TForm5::SettingsEnter(TObject *Sender)
{
	TBitBtn *btn = dynamic_cast<TBitBtn *>(Sender);
	   AnsiString s=ExtractFilePath(Application->ExeName);
	   s+="/SettingButtons/"+IntToStr(0)+".bmp";
	   Form2->Product[btn->Tag].SettingButton->Glyph->LoadFromFile(s);
	   //Form2->Buttons[Form2->SettingsNum]->Glyph->LoadFromFile(s);
	   Form2->PictureNum=0;
	   Form2->SettingsNum=btn->Tag;
}
//---------------------------------------------------------------------------
void __fastcall TForm5::Button6MouseEnter(TObject *Sender)
{
for(int i=0;i<Form5->ComponentCount-1;i++)
	{
	   if(Form5->ActiveControl==Form5->Components[i] && Form5->Components[i]->ClassName()=="TEdit")
		FocusIndex=i;
	}

}
//---------------------------------------------------------------------------

void __fastcall TForm5::Button6Click(TObject *Sender)
{
TButton *button = dynamic_cast<TButton *>(Sender);         //буквы+цифры
AnsiString s=Form5->Components[FocusIndex]->ClassName();
if(Form5->Components[FocusIndex]->ClassName()=="TEdit")
	{
	  TEdit *edit = (TEdit*)Form5->Components[FocusIndex];
	  int start=edit->SelStart;
	  AnsiString s=edit->Text;
	  s.Delete(start+1,edit->SelLength);    //если выделено,то заменяем
	  s.Insert(button->Caption,start+1);    //вставляем букву
	  edit->SetFocus();
	  edit->Text=s;
	  edit->SelStart=start+1;
	  edit->SelLength=0;
	}
}
//---------------------------------------------------------------------------


void __fastcall TForm5::FormShow(TObject *Sender)
{
FocusIndex=6;
Edit1->OnClick(Sender);
if(Button53->Caption=="ABC")
	Button53->OnClick(Sender);
if(Form1->IsKeyboard)
	{
	Panel4->Visible=true;
	Height=597;
	}
	else
	{
	Panel4->Visible=false;
	Height=387;
	}

}
//---------------------------------------------------------------------------

void __fastcall TForm5::ShiftClick(TObject *Sender)
{
for(int i=0;i<Form5->ComponentCount-1;i++)
{
  if(Form5->Components[i]->ClassName()=="TButton")
  {
	TButton *button = (TButton*)Form5->Components[i];
	if(button->Parent!=Panel4)
		continue;
	if(button->Caption.Length()==1)
		if(button->Caption==button->Caption.UpperCase())
			button->Caption=button->Caption.LowerCase();
			else
			button->Caption=button->Caption.UpperCase();
  }
}
TEdit *edit = (TEdit*)Form5->Components[FocusIndex];
edit->SetFocus();
edit->SelLength=0;
edit->SelStart=100;
}
//---------------------------------------------------------------------------

void __fastcall TForm5::Button53Click(TObject *Sender)
{
if(Button53->Caption=="Sym")
	Button53->Caption="ABC";
	else
	Button53->Caption="Sym";
int foc=FocusIndex;
setlocale(LC_ALL,"rus");
char capt[]={'й','ц','у','к','е','н','г','ш','щ','з','х','ї',
'ф','і','в','а','п','р','о','л','д','ж','є','я','ч','с','м','и','т','ь','б','ю'};
char symb[]={'+','x','÷','=','%','_','/','\\','{','}','#','$',
'/','|','^','~','*','(',')','-','\"','\'',':',';','!','?',',','.','[',']','<','>'};

for(int i=0;i<Form5->ComponentCount-1;i++)
{
	if(Components[i]->ClassName()=="TButton")
		{
			TButton *btn= (TButton*)Components[i];
			int charnum=-1,symnum=-1;
			AnsiString s=btn->Caption;
			for(int i=0;i<32;i++)
			{
				AnsiString c=capt[i];
				if(btn->Caption.LowerCase()==c)
					charnum=i;
				if(btn->Caption.LowerCase()==symb[i])
					symnum=i;
			}
			if(charnum!=-1)
			{
				btn->Caption=symb[charnum];
			}
			if(symnum!=-1)
			{
				AnsiString c=capt[symnum];
				btn->Caption=c;
			}
        }
}
FocusIndex=foc;
}
//---------------------------------------------------------------------------

void __fastcall TForm5::Edit2Click(TObject *Sender)
{
TEdit *edt = dynamic_cast<TEdit *>(Sender);
for(int i=0;i<Form5->ComponentCount-1;i++)
{
	if(Form5->Components[i]->ClassName()=="TButton")
	{
		TButton *btn =(TButton *) Form5->Components[i];
		if(!(btn->Name=="Backspace"
		|| btn->Caption=="0" || btn->Caption=="1" || btn->Caption=="2"
		|| btn->Caption=="3" || btn->Caption=="4" || btn->Caption=="5"
		|| btn->Caption=="6" || btn->Caption=="7" || btn->Caption=="8"
		|| btn->Caption=="9"))
			btn->Enabled=false;
	}
}
}
//---------------------------------------------------------------------------

void __fastcall TForm5::Edit1Click(TObject *Sender)
{
for(int i=0;i<Form5->ComponentCount-1;i++)
{
	if(Components[i]->ClassName()=="TButton")
	{
		TButton *btn=(TButton*)Components[i];
		if(btn->Parent==Panel4 && btn->Enabled==false)
			{
                btn->Enabled=true;
            }
    }
}
}
//---------------------------------------------------------------------------

void __fastcall TForm5::BackspaceClick(TObject *Sender)
{
  TButton *button = dynamic_cast<TButton *>(Sender);         //backspace
  AnsiString s=Form5->Components[FocusIndex]->ClassName();
if(Form5->Components[FocusIndex]->ClassName()=="TEdit")
	{
	  TEdit *edit = (TEdit*)Form5->Components[FocusIndex];
	  int start=edit->SelStart;
	  if(edit->SelLength!=0)
		start++;
	  AnsiString s=edit->Text;
	  int length=edit->SelLength;
	  if(length==0)
		length=1;
	  s.Delete(start,length);
	  edit->SetFocus();
	  edit->Text=s;
	  if(start!=0)
		 edit->SelStart=start-1;
	  edit->SelLength=0;
	}
}
//---------------------------------------------------------------------------

void __fastcall TForm5::Button52Click(TObject *Sender)
{
TButton *button = dynamic_cast<TButton *>(Sender);         //буквы+цифры
AnsiString s=Form5->Components[FocusIndex]->ClassName();
if(Form6->Components[FocusIndex]->ClassName()=="TEdit")
	{
	  TEdit *edit = (TEdit*)Form5->Components[FocusIndex];
	  int start=edit->SelStart;
	  AnsiString s=edit->Text;
	  s.Delete(start+1,edit->SelLength);    //если выделено,то заменяем
	  s.Insert(button->Caption,start+1);    //вставляем букву
	  edit->SetFocus();
	  edit->Text=s;
	  edit->SelStart=start+1;
	  edit->SelLength=0;
	}
}
//---------------------------------------------------------------------------

void __fastcall TForm5::Button51Click(TObject *Sender)
{
TButton *button = dynamic_cast<TButton *>(Sender);         //буквы+цифры
AnsiString s=Form5->Components[FocusIndex]->ClassName();
if(Form5->Components[FocusIndex]->ClassName()=="TEdit")
	{
	  TEdit *edit = (TEdit*)Form5->Components[FocusIndex];
	  int start=edit->SelStart;
	  edit->SetFocus();
	  if(start!=0)
	 	 edit->SelStart=start-1;
    }
}
//---------------------------------------------------------------------------

void __fastcall TForm5::Button50Click(TObject *Sender)
{
TButton *button = dynamic_cast<TButton *>(Sender);         //буквы+цифры
AnsiString s=Form5->Components[FocusIndex]->ClassName();
if(Form5->Components[FocusIndex]->ClassName()=="TEdit")
	{
	  TEdit *edit = (TEdit*)Form5->Components[FocusIndex];
	  int start=edit->SelStart;
	  edit->SetFocus();
	  edit->SelStart=start+1;
	}
}
//---------------------------------------------------------------------------

